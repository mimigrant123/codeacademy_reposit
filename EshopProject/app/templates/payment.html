{% extends "base.html" %}
{% block title %}Payment – E-Shop{% endblock %}

{% block content %}
  <h2>Payment for Order #{{ order.id }}</h2>
  <p>Total Amount: $ {{ "%.2f"|format(order.total_amount) }}</p>
  <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#paymentModal">
    Pay Now
  </button>

  <!-- Payment Modal -->
  <div class="modal fade" id="paymentModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Processing Payment</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="paymentBody">
          <p>Processing your payment, please wait…</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
<script>
  const orderId = {{ order.id }};
  const paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));

  document.addEventListener('DOMContentLoaded', () => {
    // When modal opens, simulate processing
    const modalEl = document.getElementById('paymentModal');
    modalEl.addEventListener('shown.bs.modal', () => {
      const body = document.getElementById('paymentBody');
      setTimeout(() => {
        const success = Math.random() < 0.75;
        if (success) {
          body.innerHTML = '<p class="text-success">Payment completed successfully!</p>';
          // Notify server of success
          fetch(`/payment_complete/${orderId}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': '{{ csrf_token() if csrf_token is defined else "" }}'
            },
            body: JSON.stringify({ result: 'success' })
          });
        } else {
          body.innerHTML = '<p class="text-danger">Payment failed. Please try again.</p>';
          // Notify server of failure
          fetch(`/payment_complete/${orderId}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': '{{ csrf_token() if csrf_token is defined else "" }}'
            },
            body: JSON.stringify({ result: 'fail' })
          });
        }
      }, 1000);
    });

    // Automatically show modal when page loads
    paymentModal.show();
  });
</script>
{% endblock %}
